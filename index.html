<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>The Button</title>
  <meta name="ethereum-dapp-url-bar-style" content="transparent">
  <link rel="shortcut icon" href="icon.png" type="image/vnd.microsoft.icon">
  <script src="web3.js"></script>
  <script>

  var mainAccount, theButton, lastPressed, yourScore;
  var deployedBlock = 520000;
  var contractAddress = '0xb0B3F49ef8b6dE7Cddd374d5dab7689b5645F4D5'; 
  var contractABI = [{"constant":true,"inputs":[],"name":"lastPressed","outputs":[{"name":"","type":"uint256","value":"1499870209"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"press","outputs":[],"payable":false,"type":"function"},{"inputs":[],"payable":false,"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"presser","type":"address"},{"indexed":false,"name":"pressTime","type":"uint256"},{"indexed":false,"name":"score","type":"uint256"}],"name":"ButtonPress","type":"event"}];

  function init() {

    // Checks Web3 support
    if (typeof web3 !== 'undefined') {
        // If there isn't then set a provider
        web3 = new Web3(web3.currentProvider);
        document.getElementById("non-supported").style.display = "none";
        document.getElementById("nonpusher").style.display = "block";
        document.getElementById('theButton').addEventListener('click', pressButton, false);

        // get main account
        // Check if there are available accounts
        web3.eth.getAccounts(function(e,accounts){ 
            // show the floating baloon
            if (e || !accounts || accounts.length == 0) {
                document.getElementById("add-account").style.display = "block";
            } else {
              mainAccount = accounts[0];
            }
        });

        // Load the contract
        web3.eth.getCode(contractAddress, function(e, r) { 
            if (!e && r.length > 3) {
                // Load the contract
                theButton = web3.eth.contract(contractABI).at(contractAddress); 
                // LogVote is an event on the contract. Read all since block 1 million
                var buttonPressEvent = theButton.ButtonPress(null, {fromBlock: deployedBlock});
                
                // Wait for the events to be loaded
                buttonPressEvent.watch(function(error, result){
                    console.log('Button Press!', result.args.pressTime.toFixed(), result.args.presser, result.args.score.toFixed());
                    if (result.args.presser == mainAccount) {
                      yourScore = result.args.score.toFixed();
                      document.getElementById("nonpusher").style.display = "none";
                      document.getElementById("pusher").style.display = "block";
                      document.getElementById("score").textContent = yourScore;
                      document.body.style.backgroundColor = "hsl("+ (256 - yourScore) +", 50%, 50%)";

                    }
                });

            } else {
              alert("Contract not found on this network");
            }
        }) 

        // If proposal is valid, start watching the chain
        web3.eth.filter('latest').watch(function(e, res){
            if(!e) {
              theButton.lastPressed(function(error, result) {
                lastPressed = result.toFixed();
              })
                // do something
            }
        }); 

        // create interval
        setInterval(function(){
          if (lastPressed && !yourScore) {
            var score = Math.floor((Date.now() - lastPressed * 1000)/1000) % 256;
            document.getElementById("countup").textContent = score;
            document.body.style.backgroundColor = "hsl("+ (256 - score) +", 50%, 50%)";
          }
        }, 1000)

    } 
  }

  function pressButton() {
    theButton.press({from: mainAccount}, function(error, result) {
      console.log('button pressed', error, result);
    })

  }

  </script>
  <style>

      #nonpusher, #pusher, #add-acount {
        display: none;
      }

      body {
          background: hsl(255, 50%, 50%);
          font-family: 'Source Sans Pro', Helvetica, Arial, sans-serif;
          background-size: 100%;
          color: #fefefe;
      }

      .content {
          text-align: center;
          max-width: 600px;
          margin: 90px auto;
          padding: 32px;
      }

      #add-account {
          display: none;
          background: #333;
          color: #FFF;
          position: fixed;
          top: 90px;
          right: 32px;
          padding: 20px 30px;
          box-shadow: rgba(0,0,0,0.2) 0 2px 8px;    
      }

      #add-account:before {
          display: block;
          background: #333;
          transform: rotate(45deg);
          top: -9px;
          width: 20px;
          height: 20px;
          content: " ";
          position: absolute;
          left: 250px;
      }

      button {
        width: 200px;
        height: 50px;
        background: #333;
        color: #fefefe;
        font-size: 20px;
        font-weight: 800;
        border: none;
        margin: 20px auto;
        border-radius: 3px;
        border-bottom: 4px #000 solid;
      }

      h1 {
        font-size: 1000%;
      }

      h1, h2 {
        margin: 0 auto;
      }

  </style>
  </head>
  <body>

  <div id="nonpusher" class="content">
    <h2>Current score</h2>
    <h1 id="countup">loading...</h1>

    <button id="theButton">PUSH BUTTON</button>
  </div>

  <div id="pusher" class="content">
    <h2>You pressed at</h2>
    <h1 id="score">loading...</h1>
  </div>

  <div id="non-supported" class="content not-supported">
    <h2>This Browser does not support Ethereum apps. </h2> 
    <a href="http://ethereum.org">Download Mist</a>
  </div>

  <div id="add-account">
    Click here to add an account on Mist
  </div>


  <!-- <script src="https://raw.githubusercontent.com/ethereum/web3.js/0.16.0/dist/web3.min.js"></script> -->
  <script type="text/javascript">
   function autorun(){
      init();
   }
   if (document.addEventListener) document.addEventListener("DOMContentLoaded", autorun, false);
   else if (document.attachEvent) document.attachEvent("onreadystatechange", autorun);
   else window.onload = autorun;
  </script>
  </body>
</html>